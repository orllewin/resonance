<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Resonance Serial Interface</title>
	<script src="pureknob.js" type="text/javascript"></script>
	<script src="uibuilder.js" type="text/javascript"></script>
	<script src="resonanceui.js" type="text/javascript"></script>
	<link rel="stylesheet" href="style.css">
	<script>
	
		var selectedWaveform = "sine"
	
		async function patchSendListener(patchStr){
				console.log("XXXXXXXXXXX");
				console.log("sendPatch: " + patchStr);
				console.log("XXXXXXXXXXX");
				const message = "msg " + patchStr + "\n"
				await writeToPlaydate(message)
		}
		
		window.onload = function() {
			resonanceCanvasInit();
		};

		/**
		<usb-device vendor-id="1331" product-id="5740" />
		<usb-device vendor-id="4913" product-id="22336" />
		*/
		let port;
	
		if ("serial" in navigator) {
			console.log("Web Serial API is supported")
			navigator.serial.addEventListener("connect", (event) => {
				console.log("SERIAL CONNECTED: " + event)
				port = event.target
				port.open({ baudRate: 115200 })
				startListening();
			});
			
			navigator.serial.addEventListener("disconnect", (event) => {
				console.log("SERIAL DISCONNECTED")
			});
		}else{
			console.log("Web Serial API NOT supported")
		}
		
		function hideTitle(){
			document.getElementById("screen_title_container").style.display = "none";
		}
		
		function toggleEditor(){
			const editor = document.getElementById("editor_container");
			editor.style.display = editor.style.display === 'none' ? '' : 'none';
		}
		
		//https://developer.chrome.com/docs/capabilities/serial
		//https://developer.chrome.com/docs/capabilities/usb
		async function requestUsbAccess(){
			const playdateFilters = [
				{ usbVendorId: 0x1331, usbProductId: 0x5740 },
				{ usbVendorId: 0x4913, usbProductId: 0x22336 }
			];
			
			document.getElementById("controls_container").style.display = "block";
			document.getElementById("request_usb_button").style.display = "none";
			buildUI()

			//port = await navigator.serial.requestPort({ playdateFilters });
			
			await navigator.serial
			.requestPort({ playdateFilters })
			.then((_port) => {
				port = _port
				const { usbProductId, usbVendorId } = port.getInfo();
				console.log("::: usbProductId: " + usbProductId);
				console.log("::: usbVendorId: " + usbVendorId);
				port.open({ baudRate: 115200 })
				// document.getElementById("controls_container").style.display = "block";
				// document.getElementById("request_usb_button").style.display = "none";
				// buildUI()
			})
			.catch((e) => {
				console.log("NO PORT SELECTED")
			});	
		}

		function setTooltip(text) {
			document.getElementById("tooltip").textContent=text;
		}
		
		function resetTooltip(){
			document.getElementById("tooltip").textContent="";
		}
		
		async function waveformSelect(waveform){
			
			selectedWaveform = waveform;
			
			if(waveform === "phase" || waveform === "digital" || waveform === "vosim"){
				document.getElementById("synth_param_container").style.visibility = 'visible';
			}else{
				document.getElementById("synth_param_container").style.visibility = 'hidden';
			}
			const message = "msg wf " + waveform + "\n"
			console.log("Waveform: message: " + message)
			await writeToPlaydate(message)
		}
		
		async function waveformParam1(value){
			console.log("param1: " + value)
			const message = "msg wfp1 " + value + "\n"
			await writeToPlaydate(message)
		}
		
		async function waveformParam2(value){
			console.log("param2: " + value)
			const message = "msg wfp2 " + value + "\n"
			await writeToPlaydate(message)
		}
		
		async function setParam(target, value){
			document.getElementById("tooltip").textContent="" + target + ": " + value;
			const message = "msg " + target + " " + value + "\n"
			await writeToPlaydate(message)
		}
		
		async function startListening(){
			console.log("startListening...");
			await readFromPlaydate();
			
			patchSendListener("prq");
		}
		
		async function readFromPlaydate() {	
			const textDecoder = new TextDecoderStream();
			const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
			const reader = textDecoder.readable.getReader();
			
			while (true) {
				const {value, done } = await reader.read();
				
				if(value.startsWith("<")){
					console.log("serial in: " + value);
					let commands = value.split("<")
					for (var i = 0; i < commands.length; i++) {
						let command = commands[i].trim();
						
						let tokens = command.split(" ");
						console.log("processing command: " + command + " first token: " + tokens[0]);
						if(tokens[0] == "patch"){
							clearAllFromSerial()
						}else if (tokens[0] == "plyr"){
							addPlayerFromSerial(parseInt(tokens[1]), parseInt(tokens[2]), parseInt(tokens[3]) * 2);
						}else if (tokens[0] == "note"){
							addNoteFromSerial(parseInt(tokens[1]), parseInt(tokens[2]), parseInt(tokens[3]));
						}
					}
				}
				
				if (done) {
					reader.releaseLock();
					break;
				}
			}
		}	
		
		async function writeToPlaydate(message) {	
			console.log("> " + message)		
			const encoder = new TextEncoder();
			const writer = port.writable.getWriter();
			await writer.write(encoder.encode(message));
			writer.releaseLock();
		}	
	</script>
</head>
<body>		
	<div id="screen_title_container">
	<span id="screen_title" onclick="hideTitle()">ORLLEWIN</span>
	<span id="screen_subtitle">Playdate Serial Interface</span>
	<button id="request_usb_button" type="button" onclick="requestUsbAccess()">Request USB access</button>
	</div>
	
	
	<div id="controls_container">
		
		<div id="editor_container" style="display: block;">
			<canvas id="resonance_canvas" width="400" height="240"></canvas>
			<div id="resonance_controls_container">
				<table style="width: 400px;">
					<tr>
						<td align="left" style="height: 48px;vertical-align: centre;">
							<input type="range" id="visitor_radius" name="visitor_radius" min="0" max="60" style="margin-top:0px;margin-right: 4px;width:96px;" onchange="setVisitorSize(this.value)"></input>
							<button type="button" onclick="newVisitorNode()">&#x25CB;</button>
						</td>
						<td  style="height: 48px;vvertical-align: centre;">
							<select name="notes_dropdown" id="notes_dropdown" oninput="setNote(this.value)" style="margin-right: 4px;width:100px;">
							</select>
							<button type="button" onclick="newNoteNode()">&#x25CF</button>
						</td>
						<td align="right"  style="height: 48px;vertical-align: centre;">
							<button class="control_button" type="button" onclick="clearAll()" style="height: 22px;font-size: 12px;margin-top:8px;">Clear all</button> 
						</td>
					</tr>
				</table> 
				<div style="display: block;">
					<table style="width: 400px;">
						<tr>
							<td align="left" style="height: 24px;vertical-align: centre;">
								<button class="control_button" type="button" onclick="octUp()" style="height: 22px;font-size: 12px;margin-top:0px;">Oct &#x2191;</button> <button class="control_button" type="button" onclick="octDown()" style="height: 22px;font-size: 12px;margin-top:0px;">Oct &#x2193;</button> <button class="control_button" type="button" onclick="startListening()" style="height: 22px;font-size: 12px;margin-top:0px;">Listen</button> 
							</td>
							<td  style="height: 24px;vvertical-align: centre;">
							
							</td>
							<td align="right"  style="height: 24px;vertical-align: centre;">
								RESONANCE
							</td>
						</tr>
					</table> 
				</div>
			</div>
		</div>
		
		<!-- 1 -->
		<!-- Pre-Delay -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">1. Delay (Pre)</div>
			</div>
			<div class="knob_container" id="pre_delay_time_container"></div>
			<div class="knob_container" id="pre_delay_feedback_container"></div>
			<div class="knob_container" id="pre_delay_mix_container"></div>
		</div>
		
		<!-- 2 -->
		<!-- Ringmod -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">2. Ringmod</div>
			</div>
			<div class="knob_container" id="ringmod_freq_container"></div>
			<div class="knob_container" id="ringmod_mix_container"></div>
			<div class="knob_container" style="width: 75px;" id="ringmod_blank_container"></div>
		</div>
			
		<!-- 3 -->
		<!-- Bitcrusher -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">3. Bitcrusher</div>
			</div>
			<div class="knob_container" id="bitcrusher_amount_container"></div>
			<div class="knob_container" id="bitcrusher_undersampling_container"></div>
			<div class="knob_container" id="bitcrusher_mix_container"></div>
		</div>
		
		<!-- 4 -->
		<!-- Overdrive -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">4. Overdrive</div>
			</div>
			<div class="knob_container" id="overdrive_gain_container"></div>
			<div class="knob_container" id="overdrive_limit_container"></div>
			<div class="knob_container" id="overdrive_mix_container"></div>
		</div>
		
		<!-- 5 -->
		<!-- Mid-Delay -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">5. Delay (Mid)</div>
			</div>
			<div class="knob_container" id="mid_delay_time_container"></div>
			<div class="knob_container" id="mid_delay_feedback_container"></div>
			<div class="knob_container" id="mid_delay_mix_container"></div>
		</div>
		
		<!-- 6 -->
		<!-- Low-pass -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">6. Low-pass</div>
			</div>
			<div class="knob_container" id="lowpass_freq_container"></div>
			<div class="knob_container" id="lowpass_res_container"></div>
			<div class="knob_container" id="lowpass_mix_container"></div>
		</div>
		
		<!-- 7 -->
		<!-- High-pass -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">7. High-pass</div>
			</div>
			<div class="knob_container" id="highpass_freq_container"></div>
			<div class="knob_container" id="highpass_res_container"></div>
			<div class="knob_container" id="highpass_mix_container"></div>
		</div>
		
		<!-- 8 -->
		<!-- Post Delay -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">8. Delay (Post)</div>
			</div>
			<div class="knob_container" id="delay_time_container"></div>
			<div class="knob_container" id="delay_feedback_container"></div>
			<div class="knob_container" id="delay_mix_container"></div>
		</div>
		
		<div class="effect_container" style="width: 250px;">
			<div class="effect_title_container">
				<div class="effect_title">Waveform</div>
			</div>
			<div class="waveform_select_container" id="waveform_container1">
				<div>
					<input type="radio" id="sine" name="waveform" value="sine" onchange="waveformSelect(this.value)" checked />
					<label for="sine">Sine</label>
				</div>
				<div>
					<input type="radio" id="square" name="waveform" value="square" onchange="waveformSelect(this.value)"/>
					<label for="square">Square</label>
				</div>
				<div>
					<input type="radio" id="sawtooth" name="waveform" value="sawtooth" onchange="waveformSelect(this.value)" />
					<label for="sawtooth">Sawtooth</label>
				</div>
				<div>
					<input type="radio" id="triangle" name="waveform" value="triangle" onchange="waveformSelect(this.value)" />
					<label for="triangle">Triangle</label>
				</div>
			</div>
			<div class="waveform_select_container" id="waveform_container2">
				<div>
					<input type="radio" id="phase" name="waveform" value="phase" onchange="waveformSelect(this.value)" />
					<label for="phase">Phase</label>
				</div>
				<div>
					<input type="radio" id="digital" name="waveform" value="digital" onchange="waveformSelect(this.value)" />
					<label for="digital">Digital</label>
				</div>
				<div>
					<input type="radio" id="vosim" name="waveform" value="vosim" onchange="waveformSelect(this.value)" />
					<label for="vosim">Vosim</label>
				</div>
				<div>
					<input type="radio" id="noise" name="waveform" value="noise" onchange="waveformSelect(this.value)" />
					<label for="noise">Noise</label>
				</div>
			</div>
		</div>
		
		<div class="effect_container" id="synth_param_container" style="visibility: hidden;">
			<div class="effect_title_container">
				<div class="effect_title">Synth Parameters</div>
			</div>
			<div class="knob_container" id="synth_param1_container"></div>
			<div class="knob_container" id="synth_param2_container"></div>
			<div class="knob_container" style="width: 75px;" id="param_blank_container"></div>
			</div>
		</div>
		
	</div>
	<div id="tooltip_container">
		<span id="tooltip">&#xA9;2025 orllewin.uk&nbsp;<a href="javascript:null" onClick="javascript:toggleEditor()">toggle editor</a></span>
	</div>
</body>
</html>

