<html>
<head>
	<title>Resonance Serial Interface</title>
	<script src="pureknob.js" type="text/javascript"></script>
	<script src="uibuilder.js" type="text/javascript"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<style>
		body{
			font-family: sans-serif;
			margin: 4px;
			background: black;
			color: ghostwhite;
		}
		fieldset{
			border-radius: 5px;
		}
		#screen_title_container{
			cursor: pointer;
		}
		#screen_title{
			display: block;
			font-size: 16px;
			text-transform: uppercase;
			font-weight: 500;
			padding-top: 8px;
			padding-left: 8px;	 
			color: antiquewhite;
		}
		#screen_subtitle{
			display: block;
			font-size: 14px;
			font-weight: 500;
			padding-left: 8px;	
			padding-bottom: 8px;
			color: antiquewhite;
		}
		#request_usb_button{
			margin-top: 16px;
			padding: 8px;
			margin-left: 8px;
		}
		#controls_container{
			display: none;
		}
		#tooltip_container{
			position: fixed;
			left: 0;
			bottom: 0;
			padding: 8px;
		}
		.effect_container{
			float: left;
			border-radius: 5px;
			background: #242424;
			padding: 8px;
			flex-direction: row;
			margin: 4px;
		}
		.effect_title_container{
			width:100%;
			padding-left: 4px;
			padding-right: 4px;
			padding-bottom: 8px;
		}
		.effect_title{
			display: contents;
			vertical-align: middle;
			font-size: 14px;
			font-weight: 400;
			color: antiquewhite;
		}
		.collapse_icon{
			float: right;
			vertical-align: middle;
			cursor: pointer;
		}
		.collapse_svg{
			padding-right: 8px;
			padding-bottom: 6px;
		}
		.waveform_select_container {
			float:left;
			width: 125px;
			padding-bottom: 5px;
		}
		.knob_container{
			float: left;
			border-radius: 5px;
			display: flex; 
			flex-direction: row;
			padding: 4px;
		}
		.sliders_container{
			float: left;
			border-radius: 5px;
			display: flex; 
			flex-direction: row;
		}
		.slider_container{
			border-radius: 5px;
			background: #303030;
			width: 44px;
			padding-top: 8px;
			padding-bottom: 8px;
			margin-left: 4px;
			margin-right: 4px;	
		}

		.slider_label{
			text-align: center;
			margin-block-start: 8px;
			margin-block-end: 0px;
			font-weight: 400;
			cursor: pointer;  
		}
		#tooltip{
			font-size: small;
			color: antiquewhite;
		}

		input[type=range][orient=vertical] {
				display: block;
				margin-left: auto;
				margin-right: auto;
				writing-mode: vertical-lr;
				direction: rtl;
				appearance: slider-vertical;
				width: 32;
				vertical-align: bottom;
				cursor: pointer;
				accent-color: rgb(153, 153, 153);
		
		}
		
	</style>
	<script>
	/**
	<usb-device vendor-id="1331" product-id="5740" />
	 <usb-device vendor-id="4913" product-id="22336" />
	 */
		let port;
	
		if ("serial" in navigator) {
			console.log("Web Serial API is supported")
			navigator.serial.addEventListener("connect", (event) => {
				console.log("SERIAL CONNECTED")
			});
			
			navigator.serial.addEventListener("disconnect", (event) => {
				console.log("SERIAL DISCONNECTED")
			});
		}else{
			console.log("Web Serial API NOT supported")
		}
		
		function hideTitle(){
			document.getElementById("screen_title_container").style.display = "none";
		}
		
		//https://developer.chrome.com/docs/capabilities/serial
		//https://developer.chrome.com/docs/capabilities/usb
		async function requestUsbAccess(){
			document.getElementById("controls_container").style.display = "block";
			document.getElementById("request_usb_button").style.display = "none";

			const playdateFilters = [
				{ usbVendorId: 0x1331, usbProductId: 0x5740 },
				{ usbVendorId: 0x4913, usbProductId: 0x22336 }
			];

			//port = await navigator.serial.requestPort({ playdateFilters });
			
			await navigator.serial
			.requestPort({ playdateFilters })
			.then((_port) => {
				port = _port
				
				const { usbProductId, usbVendorId } = port.getInfo();
				console.log("::: usbProductId: " + usbProductId);
				console.log("::: usbVendorId: " + usbVendorId);
				port.open({ baudRate: 9600 })
				
				
			})
			.catch((e) => {
				console.log("NO PORT SELECTED")
			});
			
			buildUI()
		}
			
		function setTooltip(text) {
				document.getElementById("tooltip").textContent=text;
		}
		
		function resetTooltip(){
			document.getElementById("tooltip").textContent="";
		}
		
		async function waveformSelect(waveform){
			
			if(waveform === "phase" || waveform === "digital" || waveform === "vosim"){
				document.getElementById("synth_param_container").style.visibility = 'visible';
			}else{
				document.getElementById("synth_param_container").style.visibility = 'hidden';
			}
			const message = "msg wf " + waveform + "\n"
			console.log("Waveform: message: " + message)
			await sendToPlaydate(message)
		}
		
		async function waveformParam1(value){
			console.log("param1: " + value)
			const message = "msg wfp1 " + value + "\n"
			await sendToPlaydate(message)
		}
		
		async function waveformParam2(value){
			console.log("param2: " + value)
			const message = "msg wfp2 " + value + "\n"
			await sendToPlaydate(message)
		}
		
		async function setParam(target, value){
			document.getElementById("tooltip").textContent="" + target + ": " + value;
			const message = "msg " + target + " " + value + "\n"
			console.log("Sending to Playdate: " + message)
			await sendToPlaydate(message)
		}
		
		async function sendToPlaydate(message) {			
				const encoder = new TextEncoder();
				const writer = port.writable.getWriter();
				await writer.write(encoder.encode(message));
				writer.releaseLock();
		}
		
	</script>
</head>
<body>		
	<div id="screen_title_container">
	<span id="screen_title" onclick="hideTitle()">ORLLEWIN</span>
	<span id="screen_subtitle">Playdate Serial Interface</span>
	<button id="request_usb_button" type="button" onclick="requestUsbAccess()">Request USB Access</button>
	</div>

	<div id="controls_container">
		<!-- 1 -->
		<!-- Pre-Delay -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">1. Delay (Pre)</div>
			</div>
			<div class="knob_container" id="pre_delay_time_container"></div>
			<div class="knob_container" id="pre_delay_feedback_container"></div>
			<div class="knob_container" id="pre_delay_mix_container"></div>
		</div>
		
		<!-- 2 -->
		<!-- Ringmod -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">2. Ringmod</div>
			</div>
			<div class="knob_container" id="ringmod_freq_container"></div>
			<div class="knob_container" id="ringmod_mix_container"></div>
			<div class="knob_container" style="width: 75px;" id="ringmod_blank_container"></div>
		</div>
			
		<!-- 3 -->
		<!-- Bitcrusher -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">3. Bitcrusher</div>
			</div>
			<div class="knob_container" id="bitcrusher_amount_container"></div>
			<div class="knob_container" id="bitcrusher_undersampling_container"></div>
			<div class="knob_container" id="bitcrusher_mix_container"></div>
		</div>
		
		<!-- 4 -->
		<!-- Overdrive -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">4. Overdrive</div>
			</div>
			<div class="knob_container" id="overdrive_gain_container"></div>
			<div class="knob_container" id="overdrive_limit_container"></div>
			<div class="knob_container" id="overdrive_mix_container"></div>
		</div>
		
		<!-- 5 -->
		<!-- Mid-Delay -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">5. Delay (Mid)</div>
			</div>
			<div class="knob_container" id="mid_delay_time_container"></div>
			<div class="knob_container" id="mid_delay_feedback_container"></div>
			<div class="knob_container" id="mid_delay_mix_container"></div>
		</div>
		
		<!-- 6 -->
		<!-- Low-pass -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">6. Low-pass</div>
			</div>
			<div class="knob_container" id="lowpass_freq_container"></div>
			<div class="knob_container" id="lowpass_res_container"></div>
			<div class="knob_container" id="lowpass_mix_container"></div>
		</div>
		
		<!-- 7 -->
		<!-- High-pass -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">7. High-pass</div>
			</div>
			<div class="knob_container" id="highpass_freq_container"></div>
			<div class="knob_container" id="highpass_res_container"></div>
			<div class="knob_container" id="highpass_mix_container"></div>
		</div>
		
		<!-- 8 -->
		<!-- Post Delay -->
		<div class="effect_container">
			<div class="effect_title_container">
				<div class="effect_title">8. Delay (Post)</div>
			</div>
			<div class="knob_container" id="delay_time_container"></div>
			<div class="knob_container" id="delay_feedback_container"></div>
			<div class="knob_container" id="delay_mix_container"></div>
		</div>
		
		<div class="effect_container" style="width: 250px;">
			<div class="effect_title_container">
				<div class="effect_title">Waveform</div>
			</div>
			<div class="waveform_select_container" id="waveform_container1">
				<div>
					<input type="radio" id="sine" name="waveform" value="sine" onchange="waveformSelect(this.value)" checked />
					<label for="sine">Sine</label>
				</div>
				<div>
					<input type="radio" id="square" name="waveform" value="square" onchange="waveformSelect(this.value)"/>
					<label for="square">Square</label>
				</div>
				<div>
					<input type="radio" id="sawtooth" name="waveform" value="sawtooth" onchange="waveformSelect(this.value)" />
					<label for="sawtooth">Sawtooth</label>
				</div>
				<div>
					<input type="radio" id="triangle" name="waveform" value="triangle" onchange="waveformSelect(this.value)" />
					<label for="triangle">Triangle</label>
				</div>
			</div>
			<div class="waveform_select_container" id="waveform_container2">
				<div>
					<input type="radio" id="phase" name="waveform" value="phase" onchange="waveformSelect(this.value)" />
					<label for="phase">Phase</label>
				</div>
				<div>
					<input type="radio" id="digital" name="waveform" value="digital" onchange="waveformSelect(this.value)" />
					<label for="digital">Digital</label>
				</div>
				<div>
					<input type="radio" id="vosim" name="waveform" value="vosim" onchange="waveformSelect(this.value)" />
					<label for="vosim">Vosim</label>
				</div>
				<div>
					<input type="radio" id="noise" name="waveform" value="noise" onchange="waveformSelect(this.value)" />
					<label for="noise">Noise</label>
				</div>
			</div>
		</div>
		
		<div class="effect_container" id="synth_param_container" style="visibility: hidden;">
			<div class="effect_title_container">
				<div class="effect_title">Synth Parameters</div>
			</div>
			<div class="knob_container" id="synth_param1_container"></div>
			<div class="knob_container" id="synth_param2_container"></div>
			<div class="knob_container" style="width: 75px;" id="param_blank_container"></div>
			</div>
		</div>
		
	</div>
	<div id="tooltip_container">
		<span id="tooltip">Â©2025 orllewin.uk</span>
	</div>
</body>
</html>

